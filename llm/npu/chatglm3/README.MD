## ğŸš£â€â™‚ï¸ ä½¿ç”¨PaddleNLPåœ¨NPUä¸‹è·‘é€šchatglmv3-6bæ¨¡å‹

##  ğŸš€ å¿«é€Ÿå¼€å§‹ ğŸš€

### ï¼ˆ0ï¼‰åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦æœ‰ä¸€å°æ˜‡è…¾NPUæœºå™¨ï¼Œå¯¹æ­¤æœºå™¨çš„ç³»ç»Ÿè¦æ±‚å¦‚ä¸‹ï¼š

 | èŠ¯ç‰‡ç±»å‹ | é©±åŠ¨ç‰ˆæœ¬ | CANNç‰ˆæœ¬ |
 | --- | --- | --- |
 | æ˜‡è…¾910 | 23.0.3 | CANN 8.0.RC1 |

**æ³¨ï¼šæœ¬ç¤ºä¾‹ä½¿ç”¨8å¡æœºå™¨ï¼Œå¹¶é€šè¿‡å¾®è°ƒè®­ç»ƒ+æ¨ç†çš„æµç¨‹æ¼”ç¤ºè¿è¡Œæ–¹æ³•**
**æ³¨ï¼šå¦‚æœè¦éªŒè¯æ‚¨çš„æœºå™¨æ˜¯å¦ä¸ºæ˜‡è…¾910BèŠ¯ç‰‡ï¼Œåªéœ€ç³»ç»Ÿç¯å¢ƒä¸‹è¾“å…¥å‘½ä»¤ï¼Œçœ‹æ˜¯å¦æœ‰è¾“å‡ºï¼š**
```
lspci | grep d802

#ä¾‹å¦‚ï¼š$ lspci | grep d802 , è¾“å‡ºå¦‚ä¸‹
28:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
29:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
38:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
39:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
48:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
49:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
59:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
5a:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
98:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
99:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
b8:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
b9:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
c8:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
c9:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
d9:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
da:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
```

### ï¼ˆ1ï¼‰ç¯å¢ƒå‡†å¤‡ï¼š(è¿™å°†èŠ±è´¹æ‚¨5ï½15minæ—¶é—´)
1. æ‹‰å–é•œåƒ
```
# æ³¨æ„æ­¤é•œåƒä»…ä¸ºå¼€å‘ç¯å¢ƒï¼Œé•œåƒä¸­ä¸åŒ…å«é¢„ç¼–è¯‘çš„é£æ¡¨å®‰è£…åŒ…
docker pull registry.baidubce.com/device/paddle-npu:cann80RC1-ubuntu20-x86_64-gcc84-py39
```
2. å‚è€ƒå¦‚ä¸‹å‘½ä»¤å¯åŠ¨å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡è®¾ç½® ASCEND_RT_VISIBLE_DEVICES æŒ‡å®šå®¹å™¨å¯è§çš„æ˜‡è…¾å¡å·
```
docker run -it --name paddle-npu-dev -v $(pwd):/work \
    --privileged --network=host --shm-size=128G -w=/work \
    -v /usr/local/Ascend/driver:/usr/local/Ascend/driver \
    -v /usr/local/bin/npu-smi:/usr/local/bin/npu-smi \
    -v /usr/local/dcmi:/usr/local/dcmi \
    -e ASCEND_RT_VISIBLE_DEVICES="0,1,2,3,4,5,6,7" \
    registry.baidubce.com/device/paddle-npu:cann80RC1-ubuntu20-x86_64-gcc84-py39 /bin/bash
```
3. å®‰è£…paddle
```
# paddlepaddleã€é£æ¡¨ã€æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œæä¾›è¿ç®—åŸºç¡€èƒ½åŠ›
python -m pip install paddlepaddle==3.0.0b0 -i https://www.paddlepaddle.org.cn/packages/stable/cpu/
```
4. å®‰è£…paddleCustomDevice
```
# paddleCustomDeviceæ˜¯paddlepaddleã€é£æ¡¨ã€æ·±åº¦å­¦ä¹ æ¡†æ¶çš„è‡ªå®šä¹‰ç¡¬ä»¶æ¥å…¥å®ç°ï¼Œæä¾›NPUçš„ç®—å­å®ç°ã€‚
python -m pip install paddle-custom-npu==3.0.0b0 -i https://www.paddlepaddle.org.cn/packages/stable/npu/
# å¦‚æƒ³æºç ç¼–è¯‘å®‰è£…ï¼Œè¯·å‚è€ƒhttps://github.com/PaddlePaddle/PaddleCustomDevice/blob/develop/backends/npu/README_cn.md
```
5. å…‹éš†PaddleNLPä»“åº“ä»£ç ï¼Œå¹¶å®‰è£…ä¾èµ–
```
# PaddleNLPæ˜¯åŸºäºpaddlepaddleã€é£æ¡¨ã€çš„è‡ªç„¶è¯­è¨€å¤„ç†å’Œå¤§è¯­è¨€æ¨¡å‹(LLM)å¼€å‘åº“ï¼Œå­˜æ”¾äº†åŸºäºã€é£æ¡¨ã€æ¡†æ¶å®ç°çš„å„ç§å¤§æ¨¡å‹ï¼Œllama2-13Bæ¨¡å‹ä¹ŸåŒ…å«å…¶ä¸­ã€‚ä¸ºäº†ä¾¿äºæ‚¨æ›´å¥½åœ°ä½¿ç”¨PaddleNLPï¼Œæ‚¨éœ€è¦cloneæ•´ä¸ªä»“åº“ã€‚
git clone https://github.com/PaddlePaddle/PaddleNLP.git
cd PaddleNLP
python -m pip install -r requirements.txt
python -m pip install -e .
```
6. å®‰è£… paddlenlp_ops
```
# PaddleNLPä»“åº“å†…ç½®äº†éƒ¨åˆ†æ˜‡è…¾ä¸“ç”¨çš„èåˆç®—å­ï¼Œä»¥ä¾¿ç”¨æˆ·äº«å—åˆ°æè‡´å‹ç¼©çš„æ¨ç†æˆæœ¬
cd csrc/npu
python setup.py build bdist_wheel
pip install dist/paddlenlp_ops-0.0.0-cp39-cp39-linux_x86_64.whl
cd -
```
### ï¼ˆ2ï¼‰æ•°æ®å‡†å¤‡ï¼š(è¿™å°†èŠ±è´¹æ‚¨2ï½5minæ—¶é—´)
sftä¸ºç²¾è°ƒç­–ç•¥ï¼Œæˆ‘ä»¬æä¾›äº†å¹¿å‘Šç”Ÿæˆæ•°æ®é›†demoä¾¿äºæ‚¨è°ƒè¯•ä½¿ç”¨
```
#ç²¾è°ƒï¼šä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬ä¹Ÿæä¾›äº†å¹¿å‘Šç”Ÿæˆæ•°æ®é›†å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š
cd llm/npu/baichuan
wget https://bj.bcebos.com/paddlenlp/datasets/examples/AdvertiseGen.tar.gz
tar -zxvf AdvertiseGen.tar.gz
```
æˆ‘ä»¬æ”¯æŒçš„ç²¾è°ƒæ•°æ®æ ¼å¼æ˜¯æ¯è¡ŒåŒ…å«ä¸€ä¸ªå­—å…¸çš„jsonæ–‡ä»¶ï¼Œæ¯ä¸ªå­—å…¸åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- `src`: `str, List(str)`ï¼ŒæŒ‡æ¨¡å‹çš„è¾“å…¥æŒ‡ä»¤ï¼ˆinstructionï¼‰ã€æç¤ºï¼ˆpromptï¼‰ï¼Œæ¨¡å‹åº”è¯¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚
- `tgt`: `str, List(str)`ï¼ŒæŒ‡æ¨¡å‹çš„è¾“å‡ºã€‚
æ ·ä¾‹æ•°æ®ï¼š
```
{"src": "ç±»å‹#è£™*é¢œè‰²#è“è‰²*é£æ ¼#æ¸…æ–°*å›¾æ¡ˆ#è´è¶ç»“", "tgt": "è£™èº«å¤„é‡‡ç”¨ç«‹ä½“è´è¶ç»“è£…é¥°è¾…ä»¥è“è‰²æ¡å¸¦ç‚¹ç¼€ï¼Œä»¤è¡£èº«é€ å‹é¥±æ»¡å¯Œæœ‰å±‚æ¬¡çš„åŒæ—¶ä¸ºå…¶æ³¨å…¥ä¸€ä¸ç”œç¾æ°”æ¯ã€‚å°†å¥³å­©æ¸…æ–°å¨‡ä¿çš„ä¸€é¢è¡¬æ‰˜è€Œå‡ºã€‚"}
...
#æ‚¨å¯ä»¥æ ¹æ®æ­¤æ ¼å¼è‡ªè¡Œåˆ¶ä½œç²¾è°ƒæ•°æ®ã€‚
```

### ï¼ˆ3ï¼‰æ¨¡å‹å‡†å¤‡
æ— æ³•ç›´æ¥é€šè¿‡æ¨¡å‹åè¿›è¡Œæ¨¡å‹åŠ è½½ï¼Œéœ€è¦å…ˆè¿è¡Œmodel_download.pyæ–‡ä»¶ï¼Œä¸‹è½½å®˜ç½‘æä¾›çš„é¢„è®­ç»ƒæ¨¡å‹åˆ°æœ¬çº§modelç›®å½•ä¸‹ï¼Œå¹¶è‡ªåŠ¨è¿›è¡Œæ¨¡å‹å±‚è½¬æ¢ã€‚
```
# è¿è¡Œsftç­–ç•¥
python model_download.py --model_name THUDM/chatglm3-6b 
```

### ï¼ˆ4ï¼‰è®­ç»ƒ
æˆ‘ä»¬åœ¨æœ¬ç›®å½•ä¸­æä¾›äº†å¯¹åº”Pretrain/SFT/LoRAçš„ä¸‰ä¸ªå…¥å£è„šæœ¬ï¼Œå¹¶å·²ç»æŒ‰ç…§8å¼ 910èŠ¯ç‰‡çš„è®­ç»ƒèµ„æºä¼˜åŒ–äº†å¹¶è¡Œç­–ç•¥ç­‰é…ç½®ä¾›æ‚¨å‚è€ƒã€‚å¯åŠ¨å¾®è°ƒè®­ç»ƒçš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š
```
# è¿è¡Œsftç­–ç•¥
bash chatglm3_npu_sft_N1C4.sh
```
### ï¼ˆ5ï¼‰æ¨ç†
æ¨ç†å‰éœ€è¦å‡†å¤‡æ¨ç†ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨mergeå¥½å‚æ•°çš„è·¯å¾„ä¸‹(æœ¬æ•™ç¨‹ä¸‹è·¯å¾„ä¸ºï¼š`./output/sft_tf16_chatglm_N1C4`)å°†`config.json`æ›´æ”¹ä¸ºä¸‹é¢çš„å†…å®¹ï¼š
```
{
   "architectures": [
    "chatglmv3forcausallm"
  ],
  "add_bias_linear": false,
  "add_qkv_bias": true,
  "apply_query_key_layer_scaling": true,
  "apply_residual_connection_post_layernorm": false,
  "attention_dropout": 0.0,
  "attention_softmax_in_fp32": true,
  "bias_dropout_fusion": true,
  "ffn_hidden_size": 13696,
  "num_key_value_heads": 2,
  "fp32_residual_connection": false,
  "hidden_dropout": 0.0,
  "hidden_size": 4096,
  "kv_channels": 128,
  "layernorm_epsilon": 1e-05,
  "multi_query_attention": true,
  "multi_query_group_num": 2,
  "num_attention_heads": 32,
  "num_layers": 28,
  "original_rope": true,
  "padded_vocab_size": 65024,
  "post_layer_norm": true,
  "rmsnorm": true,
  "seq_length": 2048,
  "use_cache": true,
  "torch_dtype": "float16",
  "transformers_version": "4.30.2",
  "tie_word_embeddings": false,
  "eos_token_id": 2,
  "pad_token_id": 0
}
```
ä»è®­ç»ƒäº§å‡ºçš„åŠ¨æ€å›¾æ¨¡å‹ä¸­å¯¼å‡ºé™æ€å›¾æ¨¡å‹ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œå¯¼å‡ºï¼š
```
bash export_npu.sh ./output/sft_tf16_chatglm_N1C4/ ./inference
```
æœ€ç»ˆï¼Œæˆ‘ä»¬é€šè¿‡é™æ€å›¾çš„æ¨¡å‹æ‰§è¡Œæ¨ç†, å¦‚æœä½¿ç”¨chatæ¨¡å‹ï¼Œéœ€è¦è°ƒç”¨tokenizerçš„build_chat_input()è¿›è¡Œç¼–ç æ„å»ºã€‚
```
# æ‰§è¡Œæ¨ç†ä»£ç 
bash predict_npu.sh ./inference
```
```

***********Source**********
æ™šä¸Šç¡ä¸ç€åº”è¯¥æ€ä¹ˆåŠ?
***********Target**********

***********Output**********

 æ™šä¸Šç¡ä¸ç€å¯ä»¥å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š

1. ä¿æŒå†·é™ï¼šä¸è¦å› ä¸ºç¡ä¸ç€è€Œç„¦è™‘ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ›´ä¸¥é‡çš„å¤±çœ ã€‚

2. å°è¯•æ”¾æ¾æŠ€å·§ï¼šæ·±å‘¼å¸ã€æ¸è¿›æ€§è‚Œè‚‰æ¾å¼›ç­‰æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©ä½ æ”¾æ¾èº«å¿ƒï¼Œæ›´å®¹æ˜“å…¥ç¡ã€‚

3. ä¿æŒè§„å¾‹ä½œæ¯ï¼šå°½é‡æ¯å¤©æŒ‰æ—¶ä¸ŠåºŠç¡è§‰ï¼Œä¿æŒè§„å¾‹çš„ä½œæ¯ä¹ æƒ¯ã€‚

4. é¿å…è¿‡å¤šæ¥è§¦ç”µå­äº§å“ï¼šæ™šä¸Šç¡è§‰å‰ä¸€ä¸ªå°æ—¶å·¦å³ï¼Œå°½é‡å‡å°‘æˆ–è€…ä¸æ¥è§¦ç”µå­äº§å“ï¼Œé¿å…è“å…‰è¾å°„å½±å“ç¡çœ è´¨é‡ã€‚

5. æ³¨æ„é¥®é£Ÿå¥åº·ï¼šä¿æŒè‰¯å¥½çš„é¥®é£Ÿä¹ æƒ¯ï¼Œå¤šé£Ÿç”¨æ–°é²œæ°´æœè”¬èœï¼Œä¸è¦æš´é¥®æš´é£Ÿï¼Œè¦é¿å…è¿‡å¤šé£Ÿç”¨æ²¹è…»æ€§é£Ÿç‰©ï¼Œå¤šæ³¨æ„é¥®é£Ÿæ¸…æ·¡å¥åº·ã€‚

```



