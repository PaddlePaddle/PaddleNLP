## ğŸš£â€â™‚ï¸ ä½¿ç”¨PaddleNLPåœ¨NPUä¸‹è·‘é€šbaichuan2-13bæ¨¡å‹

##  ğŸš€ å¿«é€Ÿå¼€å§‹ ğŸš€

### ï¼ˆ0ï¼‰åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦æœ‰ä¸€å°æ˜‡è…¾NPUæœºå™¨ï¼Œå¯¹æ­¤æœºå™¨çš„ç³»ç»Ÿè¦æ±‚å¦‚ä¸‹ï¼š

 | èŠ¯ç‰‡ç±»å‹ | é©±åŠ¨ç‰ˆæœ¬ | CANNç‰ˆæœ¬ |
 | --- | --- | --- |
 | æ˜‡è…¾910 | 23.0.3 | CANN 8.0.RC1 |

**æ³¨ï¼šæœ¬ç¤ºä¾‹ä½¿ç”¨8å¡æœºå™¨ï¼Œå¹¶é€šè¿‡å¾®è°ƒè®­ç»ƒ+æ¨ç†çš„æµç¨‹æ¼”ç¤ºè¿è¡Œæ–¹æ³•**
**æ³¨ï¼šå¦‚æœè¦éªŒè¯æ‚¨çš„æœºå™¨æ˜¯å¦ä¸ºæ˜‡è…¾910BèŠ¯ç‰‡ï¼Œåªéœ€ç³»ç»Ÿç¯å¢ƒä¸‹è¾“å…¥å‘½ä»¤ï¼Œçœ‹æ˜¯å¦æœ‰è¾“å‡ºï¼š**
```
lspci | grep d802

#ä¾‹å¦‚ï¼š$ lspci | grep d802 , è¾“å‡ºå¦‚ä¸‹
28:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
29:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
38:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
39:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
48:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
49:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
59:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
5a:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
98:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
99:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
b8:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
b9:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
c8:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
c9:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
d9:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
da:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device d802 (rev 20)
```

### ï¼ˆ1ï¼‰ç¯å¢ƒå‡†å¤‡ï¼š(è¿™å°†èŠ±è´¹æ‚¨5ï½15minæ—¶é—´)
1. æ‹‰å–é•œåƒ
```
# æ³¨æ„æ­¤é•œåƒä»…ä¸ºå¼€å‘ç¯å¢ƒï¼Œé•œåƒä¸­ä¸åŒ…å«é¢„ç¼–è¯‘çš„é£æ¡¨å®‰è£…åŒ…
docker pull registry.baidubce.com/device/paddle-npu:cann80RC1-ubuntu20-x86_64-gcc84-py39
```
2. å‚è€ƒå¦‚ä¸‹å‘½ä»¤å¯åŠ¨å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡è®¾ç½® ASCEND_RT_VISIBLE_DEVICES æŒ‡å®šå®¹å™¨å¯è§çš„æ˜‡è…¾å¡å·
```
docker run -it --name paddle-npu-dev -v $(pwd):/work \
    --privileged --network=host --shm-size=128G -w=/work \
    -v /usr/local/Ascend/driver:/usr/local/Ascend/driver \
    -v /usr/local/bin/npu-smi:/usr/local/bin/npu-smi \
    -v /usr/local/dcmi:/usr/local/dcmi \
    -e ASCEND_RT_VISIBLE_DEVICES="0,1,2,3,4,5,6,7" \
    registry.baidubce.com/device/paddle-npu:cann80RC1-ubuntu20-x86_64-gcc84-py39 /bin/bash
```
3. å®‰è£…paddle
```
# paddlepaddleã€é£æ¡¨ã€æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œæä¾›è¿ç®—åŸºç¡€èƒ½åŠ›
python -m pip install paddlepaddle==3.0.0b0 -i https://www.paddlepaddle.org.cn/packages/stable/cpu/
```
4. å®‰è£…paddleCustomDevice
```
# paddleCustomDeviceæ˜¯paddlepaddleã€é£æ¡¨ã€æ·±åº¦å­¦ä¹ æ¡†æ¶çš„è‡ªå®šä¹‰ç¡¬ä»¶æ¥å…¥å®ç°ï¼Œæä¾›NPUçš„ç®—å­å®ç°ã€‚
python -m pip install paddle-custom-npu==3.0.0b0 -i https://www.paddlepaddle.org.cn/packages/stable/npu/
# å¦‚æƒ³æºç ç¼–è¯‘å®‰è£…ï¼Œè¯·å‚è€ƒhttps://github.com/PaddlePaddle/PaddleCustomDevice/blob/develop/backends/npu/README_cn.md
```
5. å…‹éš†PaddleNLPä»“åº“ä»£ç ï¼Œå¹¶å®‰è£…ä¾èµ–
```
# PaddleNLPæ˜¯åŸºäºpaddlepaddleã€é£æ¡¨ã€çš„è‡ªç„¶è¯­è¨€å¤„ç†å’Œå¤§è¯­è¨€æ¨¡å‹(LLM)å¼€å‘åº“ï¼Œå­˜æ”¾äº†åŸºäºã€é£æ¡¨ã€æ¡†æ¶å®ç°çš„å„ç§å¤§æ¨¡å‹ï¼Œllama2-13Bæ¨¡å‹ä¹ŸåŒ…å«å…¶ä¸­ã€‚ä¸ºäº†ä¾¿äºæ‚¨æ›´å¥½åœ°ä½¿ç”¨PaddleNLPï¼Œæ‚¨éœ€è¦cloneæ•´ä¸ªä»“åº“ã€‚
git clone https://github.com/PaddlePaddle/PaddleNLP.git
cd PaddleNLP
python -m pip install -r requirements.txt
python -m pip install -e .
```
6. å®‰è£… paddlenlp_ops
```
# PaddleNLPä»“åº“å†…ç½®äº†éƒ¨åˆ†æ˜‡è…¾ä¸“ç”¨çš„èåˆç®—å­ï¼Œä»¥ä¾¿ç”¨æˆ·äº«å—åˆ°æè‡´å‹ç¼©çš„æ¨ç†æˆæœ¬
cd csrc/npu
python setup.py build bdist_wheel
pip install dist/paddlenlp_ops-0.0.0-cp39-cp39-linux_x86_64.whl
cd -
```
### ï¼ˆ2ï¼‰æ•°æ®å‡†å¤‡ï¼š(è¿™å°†èŠ±è´¹æ‚¨2ï½5minæ—¶é—´)
sftä¸ºç²¾è°ƒç­–ç•¥ï¼Œæˆ‘ä»¬æä¾›äº†å¹¿å‘Šç”Ÿæˆæ•°æ®é›†demoä¾¿äºæ‚¨è°ƒè¯•ä½¿ç”¨
```
#ç²¾è°ƒï¼šä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬ä¹Ÿæä¾›äº†å¹¿å‘Šç”Ÿæˆæ•°æ®é›†å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š
cd llm/npu/baichuan
wget https://bj.bcebos.com/paddlenlp/datasets/examples/AdvertiseGen.tar.gz
tar -zxvf AdvertiseGen.tar.gz
```
æˆ‘ä»¬æ”¯æŒçš„ç²¾è°ƒæ•°æ®æ ¼å¼æ˜¯æ¯è¡ŒåŒ…å«ä¸€ä¸ªå­—å…¸çš„jsonæ–‡ä»¶ï¼Œæ¯ä¸ªå­—å…¸åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- `src`: `str, List(str)`ï¼ŒæŒ‡æ¨¡å‹çš„è¾“å…¥æŒ‡ä»¤ï¼ˆinstructionï¼‰ã€æç¤ºï¼ˆpromptï¼‰ï¼Œæ¨¡å‹åº”è¯¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚
- `tgt`: `str, List(str)`ï¼ŒæŒ‡æ¨¡å‹çš„è¾“å‡ºã€‚
æ ·ä¾‹æ•°æ®ï¼š
```
{"src": "ç±»å‹#è£™*é¢œè‰²#è“è‰²*é£æ ¼#æ¸…æ–°*å›¾æ¡ˆ#è´è¶ç»“", "tgt": "è£™èº«å¤„é‡‡ç”¨ç«‹ä½“è´è¶ç»“è£…é¥°è¾…ä»¥è“è‰²æ¡å¸¦ç‚¹ç¼€ï¼Œä»¤è¡£èº«é€ å‹é¥±æ»¡å¯Œæœ‰å±‚æ¬¡çš„åŒæ—¶ä¸ºå…¶æ³¨å…¥ä¸€ä¸ç”œç¾æ°”æ¯ã€‚å°†å¥³å­©æ¸…æ–°å¨‡ä¿çš„ä¸€é¢è¡¬æ‰˜è€Œå‡ºã€‚"}
...
#æ‚¨å¯ä»¥æ ¹æ®æ­¤æ ¼å¼è‡ªè¡Œåˆ¶ä½œç²¾è°ƒæ•°æ®ã€‚
```

### ï¼ˆ3ï¼‰è®­ç»ƒï¼š(è¿™å°†èŠ±è´¹æ‚¨çº¦4å°æ—¶çš„æ—¶é—´)
æˆ‘ä»¬åœ¨æœ¬ç›®å½•ä¸­æä¾›äº†å¯¹åº”Pretrain/SFT/LoRAçš„ä¸‰ä¸ªå…¥å£è„šæœ¬ï¼Œå¹¶å·²ç»æŒ‰ç…§8å¼ 910èŠ¯ç‰‡çš„è®­ç»ƒèµ„æºä¼˜åŒ–äº†å¹¶è¡Œç­–ç•¥ç­‰é…ç½®ä¾›æ‚¨å‚è€ƒã€‚å¯åŠ¨å¾®è°ƒè®­ç»ƒçš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š
```
# è¿è¡Œsftç­–ç•¥
bash baichuan2_13b_npu_sft_N1C8.sh
```
### ï¼ˆ4ï¼‰æ¨ç†
æ¨ç†å‰éœ€è¦å‡†å¤‡æ¨ç†ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨mergeå¥½å‚æ•°çš„è·¯å¾„ä¸‹(æœ¬æ•™ç¨‹ä¸‹è·¯å¾„ä¸ºï¼š`./output/sft_bf16_baichuan_N1C8`)å°†`config.json`æ›´æ”¹ä¸ºä¸‹é¢çš„å†…å®¹ï¼š
```
{
  "architectures": [
    "LlamaForCausalLM"
  ],
  "tokenizer_class": "LlamaTokenizer",
  "bos_token_id": 1,
  "eos_token_id": 2,
  "gradient_checkpointing": false,
  "hidden_act": "silu",
  "hidden_size": 5120,
  "initializer_range": 0.02,
  "intermediate_size": 13696,
  "max_position_embeddings": 4096,
  "model_type": "llama",
  "num_attention_heads": 40,
  "num_hidden_layers": 40,
  "pad_token_id": 0,
  "rms_norm_eps": 1e-06,
  "tie_word_embeddings": false,
  "dtype": "bfloat16",
  "use_cache": true,
  "alibi": true,
  "vocab_size": 125696
}
```
ä»è®­ç»ƒäº§å‡ºçš„åŠ¨æ€å›¾æ¨¡å‹ä¸­å¯¼å‡ºé™æ€å›¾æ¨¡å‹ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œå¯¼å‡ºï¼š
```
bash export_npu.sh ./output/sft_bf16_baichuan_N1C8/ ./inference
```
æœ€ç»ˆï¼Œæˆ‘ä»¬é€šè¿‡é™æ€å›¾çš„æ¨¡å‹æ‰§è¡Œæ¨ç†ï¼š
```
# æ‰§è¡Œæ¨ç†ä»£ç 
bash predict_npu.sh ./inference
```
```
***********Source**********
ç¡ä¸ç€è¯¥æ€ä¹ˆåŠï¼Ÿ
***********Target**********

***********Output**********
å¦‚æœä½ ç¡ä¸ç€ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š

1. ä¿æŒæ”¾æ¾ï¼šå°è¯•æ·±å‘¼å¸ã€æ¸è¿›æ€§è‚Œè‚‰æ¾å¼›æˆ–å†¥æƒ³ç­‰æ”¾æ¾æŠ€å·§ã€‚
2. æ”¹å˜ç¯å¢ƒï¼šè°ƒæ•´æˆ¿é—´çš„æ¸©åº¦ã€å…‰çº¿å’Œå™ªéŸ³ï¼Œåˆ›é€ ä¸€ä¸ªèˆ’é€‚çš„ç¡çœ ç¯å¢ƒã€‚
3. é¿å…å’–å•¡å› ã€å°¼å¤ä¸å’Œé…’ç²¾ï¼šè¿™äº›ç‰©è´¨å¯èƒ½ä¼šå½±å“ä½ çš„ç¡çœ è´¨é‡ã€‚
4. é™åˆ¶ç™½å¤©å°æ†©ï¼šå¦‚æœä½ ç™½å¤©æ‰“ç›¹è¿‡å¤šï¼Œå¯èƒ½ä¼šå½±å“åˆ°æ™šä¸Šçš„ç¡çœ ã€‚
5. è¿åŠ¨ï¼šå®šæœŸè¿›è¡Œæœ‰æ°§è¿åŠ¨ï¼Œå¦‚æ•£æ­¥ã€è·‘æ­¥æˆ–æ¸¸æ³³ï¼Œå¯ä»¥å¸®åŠ©æ”¹å–„ç¡çœ è´¨é‡ã€‚
6. ä¿æŒè§„å¾‹çš„ä½œæ¯æ—¶é—´ï¼šå°½é‡æ¯å¤©åœ¨ç›¸åŒçš„æ—¶é—´ä¸ŠåºŠç¡è§‰å’Œèµ·åºŠã€‚
7. é™åˆ¶ä½¿ç”¨ç”µå­è®¾å¤‡ï¼šåœ¨ç¡å‰ä¸€å°æ—¶å†…é¿å…ä½¿ç”¨æ‰‹æœºã€ç”µè„‘ç­‰ç”µå­è®¾å¤‡ï¼Œå› ä¸ºå®ƒä»¬å‘å‡ºçš„è“å…‰å¯èƒ½ä¼šå¹²æ‰°ä½ çš„ç¡çœ ã€‚
8. ä¿æŒå§å®¤æ•´æ´ï¼šä¸€ä¸ªå¹²å‡€ã€æ•´æ´çš„å§å®¤æœ‰åŠ©äºåˆ›é€ ä¸€ä¸ªè‰¯å¥½çš„ç¡çœ ç¯å¢ƒã€‚
9. å°è¯•æ¸è¿›æ€§å…¥ç¡æŠ€å·§ï¼šå¦‚æ•°æ•°æ³•ã€å¬è½»éŸ³ä¹æˆ–é˜…è¯»è½»æ¾çš„æ–‡ç« ã€‚
10. å¦‚æœé•¿æ—¶é—´æ— æ³•å…¥ç¡ï¼Œä¸è¦å¼ºè¿«è‡ªå·±ï¼šèµ·åºŠåšä¸€äº›è½»æ¾çš„æ´»åŠ¨ï¼Œå¦‚é˜…è¯»æˆ–å¬éŸ³ä¹ï¼Œç›´åˆ°æ„Ÿåˆ°å›°æ„å†å›åˆ°åºŠä¸Šã€‚

å¦‚æœå°è¯•äº†è¿™äº›æ–¹æ³•ä»ç„¶æ— æ³•æ”¹å–„ä½ çš„ç¡çœ è´¨é‡ï¼Œå»ºè®®å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿæˆ–ç¡çœ ä¸“å®¶ã€‚
```



