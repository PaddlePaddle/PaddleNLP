# äºŒåˆ†ç±»/å¤šåˆ†ç±»ä»»åŠ¡æŒ‡å—

**ç›®å½•**

- [1. äºŒåˆ†ç±»/å¤šåˆ†ç±»ç®€ä»‹](#äºŒåˆ†ç±»/å¤šåˆ†ç±»ç®€ä»‹)
- [2. å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
    - [2.1 è¿è¡Œç¯å¢ƒ](#è¿è¡Œç¯å¢ƒ)
    - [2.2 ä»£ç ç»“æ„](#ä»£ç ç»“æ„)
    - [2.3 æ•°æ®å‡†å¤‡](#æ•°æ®å‡†å¤‡)
    - [2.4 æ¨¡å‹è®­ç»ƒ](#æ¨¡å‹è®­ç»ƒ)
    - [2.5 æ¨¡å‹é¢„æµ‹](#æ¨¡å‹é¢„æµ‹)
    - [2.6 æ¨¡å‹æ•ˆæœ](#æ¨¡å‹æ•ˆæœ)


<a name="äºŒåˆ†ç±»/å¤šåˆ†ç±»ç®€ä»‹"></a>

## 1. äºŒåˆ†ç±»/å¤šåˆ†ç±»ç®€ä»‹

æœ¬é¡¹ç›®æä¾›é€šç”¨åœºæ™¯ä¸‹**åŸºäºé¢„è®­ç»ƒæ¨¡å‹å¾®è°ƒçš„äºŒåˆ†ç±»/å¤šåˆ†ç±»ç«¯åˆ°ç«¯åº”ç”¨æ–¹æ¡ˆ**ï¼Œæ‰“é€šæ•°æ®æ ‡æ³¨-æ¨¡å‹è®­ç»ƒ-æ¨¡å‹è°ƒä¼˜-æ¨¡å‹å‹ç¼©-é¢„æµ‹éƒ¨ç½²å…¨æµç¨‹ï¼Œæœ‰æ•ˆç¼©çŸ­å¼€å‘å‘¨æœŸï¼Œé™ä½AIå¼€å‘è½åœ°é—¨æ§›ã€‚

äºŒåˆ†ç±»/å¤šåˆ†ç±»æ•°æ®é›†çš„æ ‡ç­¾é›†å«æœ‰ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ç±»åˆ«ï¼Œæ‰€æœ‰è¾“å…¥å¥å­/æ–‡æœ¬æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ ‡ç­¾ã€‚åœ¨æ–‡æœ¬å¤šåˆ†ç±»åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é¢„æµ‹**è¾“å…¥å¥å­/æ–‡æœ¬æœ€å¯èƒ½æ¥è‡ª `n` ä¸ªæ ‡ç­¾ç±»åˆ«ä¸­çš„å“ªä¸€ä¸ªç±»åˆ«**ã€‚åœ¨æœ¬é¡¹ç›®ä¸­äºŒåˆ†ç±»ä»»åŠ¡è¢«è§†ä¸ºå¤šåˆ†ç±»ä»»åŠ¡ä¸­æ ‡ç­¾é›†åŒ…å«ä¸¤ä¸ªç±»åˆ«çš„æƒ…å†µï¼Œä»¥ä¸‹ç»Ÿä¸€ç§°ä¸ºå¤šåˆ†ç±»ä»»åŠ¡ã€‚ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œè¯¥æ–°é—»æ–‡æœ¬çš„æœ€å¯èƒ½çš„æ ‡ç­¾ä¸º `å¨±ä¹`ã€‚å¤šåˆ†ç±»ä»»åŠ¡åœ¨å•†å“åˆ†ç±»ã€ç½‘é¡µæ ‡ç­¾ã€æ–°é—»åˆ†ç±»ã€åŒ»ç–—æ–‡æœ¬åˆ†ç±»ç­‰å„ç§ç°å®åœºæ™¯ä¸­å…·æœ‰å¹¿æ³›çš„é€‚ç”¨æ€§ã€‚

<div align="center">
    <img src=https://user-images.githubusercontent.com/63761690/187588832-daa4294e-248e-4c69-9a4b-1cf8f25a2fcc.png width="550"/>
</div>
<br>

**æ–¹æ¡ˆäº®ç‚¹ï¼š**

- **æ•ˆæœé¢†å…ˆğŸƒï¼š** ä½¿ç”¨åœ¨ä¸­æ–‡é¢†åŸŸå†…æ¨¡å‹æ•ˆæœå’Œæ¨¡å‹è®¡ç®—æ•ˆç‡æœ‰çªå‡ºæ•ˆæœçš„ERNIE 3.0 è½»é‡çº§ç³»åˆ—æ¨¡å‹ä½œä¸ºè®­ç»ƒåŸºåº§ï¼ŒERNIE 3.0 è½»é‡çº§ç³»åˆ—æä¾›å¤šç§å°ºå¯¸çš„é¢„è®­ç»ƒæ¨¡å‹æ»¡è¶³ä¸åŒéœ€æ±‚ï¼Œå…·æœ‰å¹¿æ³›æˆç†Ÿçš„å®è·µåº”ç”¨æ€§ã€‚
- **é«˜æ•ˆè°ƒä¼˜âœŠï¼š** æ–‡æœ¬åˆ†ç±»åº”ç”¨ä¾æ‰˜[TrustAI](https://github.com/PaddlePaddle/TrustAI)å¯ä¿¡å¢å¼ºèƒ½åŠ›å’Œ[æ•°æ®å¢å¼ºAPI](https://github.com/PaddlePaddle/PaddleNLP/blob/develop/docs/dataaug.md)ï¼Œæä¾›æ¨¡å‹åˆ†ææ¨¡å—åŠ©åŠ›å¼€å‘è€…å®ç°æ¨¡å‹åˆ†æï¼Œå¹¶æä¾›ç¨€ç–æ•°æ®ç­›é€‰ã€è„æ•°æ®æ¸…æ´—ã€æ•°æ®å¢å¼ºç­‰å¤šç§è§£å†³æ–¹æ¡ˆã€‚
- **ç®€å•æ˜“ç”¨ğŸ‘¶ï¼š** å¼€å‘è€…**æ— éœ€æœºå™¨å­¦ä¹ èƒŒæ™¯çŸ¥è¯†**ï¼Œä»…éœ€æä¾›æŒ‡å®šæ ¼å¼çš„æ ‡æ³¨åˆ†ç±»æ•°æ®ï¼Œä¸€è¡Œå‘½ä»¤å³å¯å¼€å¯æ–‡æœ¬åˆ†ç±»è®­ç»ƒï¼Œè½»æ¾å®Œæˆä¸Šçº¿éƒ¨ç½²ï¼Œä¸å†è®©æŠ€æœ¯æˆä¸ºæ–‡æœ¬åˆ†ç±»çš„é—¨æ§›ã€‚

**æ›´å¤šé€‰æ‹©ï¼š**

å¯¹äºå¤§å¤šæ•°å¤šåˆ†ç±»ä»»åŠ¡ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹å¾®è°ƒä½œä¸ºé¦–é€‰çš„æ–‡æœ¬åˆ†ç±»æ–¹æ¡ˆï¼Œå¤šåˆ†ç±»é¡¹ç›®ä¸­è¿˜æä¾›é€šç”¨æ–‡æœ¬åˆ†ç±»(UTC)å’Œè¯­ä¹‰ç´¢å¼•çš„ä¸¤ç§æ–¹æ¡ˆæ»¡è¶³ä¸åŒå¼€å‘è€…éœ€æ±‚ï¼Œæ›´å¤šæŠ€æœ¯ç»†èŠ‚è¯·å‚è§[æ–‡æœ¬åˆ†ç±»æŠ€æœ¯ç‰¹è‰²ä»‹ç»](../README.md)ã€‚

- ã€é›¶æ ·æœ¬ã€å°æ ·æœ¬åœºæ™¯ã€‘ ğŸ‘‰ [é€šç”¨æ–‡æœ¬åˆ†ç±»(UTC)æ–¹æ¡ˆ](../../zero_shot_text_classification)

- ã€æ ‡ç­¾ç±»åˆ«ä¸å›ºå®šã€æ ‡ç­¾ç±»åˆ«ä¼—å¤šã€‘ ğŸ‘‰ [è¯­ä¹‰ç´¢å¼•åˆ†ç±»æ–¹æ¡ˆ](./retrieval_based)


<a name="å¿«é€Ÿå¼€å§‹"></a>

## 2. å¿«é€Ÿå¼€å§‹

æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»¥CBLUEå…¬å¼€æ•°æ®é›†KUAKE-QICä»»åŠ¡ä¸ºç¤ºä¾‹ï¼Œæ¼”ç¤ºå¤šåˆ†ç±»å…¨æµç¨‹æ–¹æ¡ˆä½¿ç”¨ã€‚ä¸‹è½½æ•°æ®é›†ï¼š

```shell
wget https://paddlenlp.bj.bcebos.com/datasets/KUAKE_QIC.tar.gz
tar -zxvf KUAKE_QIC.tar.gz
mv KUAKE_QIC data
rm -rf KUAKE_QIC.tar.gz
```

<div align="center">
    <img width="900" alt="image" src="https://user-images.githubusercontent.com/63761690/187828356-e2f4f627-f5fe-4c83-8879-ed6951f7511e.png">
</div>
<div align="center">
    <font size ="2">
    å¤šåˆ†ç±»æ•°æ®æ ‡æ³¨-æ¨¡å‹è®­ç»ƒ-æ¨¡å‹åˆ†æ-æ¨¡å‹å‹ç¼©-é¢„æµ‹éƒ¨ç½²æµç¨‹å›¾
     </font>
</div>

<a name="è¿è¡Œç¯å¢ƒ"></a>

### 2.1 è¿è¡Œç¯å¢ƒ

- python >= 3.6
- paddlepaddle >= 2.3
- paddlenlp >= 2.5.1
- scikit-learn >= 1.0.2

**å®‰è£…PaddlePaddleï¼š**

 ç¯å¢ƒä¸­paddlepaddle-gpuæˆ–paddlepaddleç‰ˆæœ¬åº”å¤§äºæˆ–ç­‰äº2.3, è¯·å‚è§[é£æ¡¨å¿«é€Ÿå®‰è£…](https://www.paddlepaddle.org.cn/install/quick?docurl=/documentation/docs/zh/install/pip/linux-pip.html)æ ¹æ®è‡ªå·±éœ€æ±‚é€‰æ‹©åˆé€‚çš„PaddlePaddleä¸‹è½½å‘½ä»¤ã€‚


**å®‰è£…PaddleNLPï¼š**

```shell
pip install --upgrade paddlenlp
```


**å®‰è£…sklearnï¼š**
```shell
pip install scikit-learn
```

<a name="ä»£ç ç»“æ„"></a>

### 2.2 ä»£ç ç»“æ„

```text
multi_class/
â”œâ”€â”€ few-shot # å°æ ·æœ¬å­¦ä¹ æ–¹æ¡ˆ
â”œâ”€â”€ retrieval_based # è¯­ä¹‰ç´¢å¼•æ–¹æ¡ˆ
â”œâ”€â”€ analysis # åˆ†ææ¨¡å—
â”œâ”€â”€ deploy # éƒ¨ç½²
â”‚   â”œâ”€â”€ simple_serving # SimpleServingæœåŠ¡åŒ–éƒ¨ç½²
â”‚Â Â  â””â”€â”€ triton_serving # TritonæœåŠ¡åŒ–éƒ¨ç½²
â”œâ”€â”€ train.py # è®­ç»ƒã€è¯„ä¼°ã€è£å‰ªè„šæœ¬
â”œâ”€â”€ utils.py # å·¥å…·å‡½æ•°è„šæœ¬
â””â”€â”€ README.md # å¤šåˆ†ç±»ä½¿ç”¨è¯´æ˜
```

<a name="æ•°æ®å‡†å¤‡"></a>

### 2.3 æ•°æ®å‡†å¤‡

è®­ç»ƒéœ€è¦å‡†å¤‡æŒ‡å®šæ ¼å¼çš„æœ¬åœ°æ•°æ®é›†,å¦‚æœæ²¡æœ‰å·²æ ‡æ³¨çš„æ•°æ®é›†ï¼Œå¯ä»¥å‚è€ƒ[æ–‡æœ¬åˆ†ç±»ä»»åŠ¡doccanoæ•°æ®æ ‡æ³¨ä½¿ç”¨æŒ‡å—](../doccano.md)è¿›è¡Œæ–‡æœ¬åˆ†ç±»æ•°æ®æ ‡æ³¨ã€‚æŒ‡å®šæ ¼å¼æœ¬åœ°æ•°æ®é›†ç›®å½•ç»“æ„ï¼š

```text
data/
â”œâ”€â”€ train.txt # è®­ç»ƒæ•°æ®é›†æ–‡ä»¶
â”œâ”€â”€ dev.txt # å¼€å‘æ•°æ®é›†æ–‡ä»¶
â””â”€â”€ label.txt # åˆ†ç±»æ ‡ç­¾æ–‡ä»¶
```

**è®­ç»ƒã€å¼€å‘ã€æµ‹è¯•æ•°æ®é›†** æ–‡ä»¶ä¸­æ–‡æœ¬ä¸æ ‡ç­¾ç±»åˆ«åç”¨tabç¬¦`'\t'`åˆ†éš”å¼€ï¼Œæ–‡æœ¬ä¸­é¿å…å‡ºç°tabç¬¦`'\t'`ã€‚

- train.txt/dev.txt/test.txt æ–‡ä»¶æ ¼å¼ï¼š
```text
<æ–‡æœ¬>'\t'<æ ‡ç­¾>
<æ–‡æœ¬>'\t'<æ ‡ç­¾>
...
```

- train.txt/dev.txt/test.txt æ–‡ä»¶æ ·ä¾‹ï¼š
```text
25å²å·²ç»æ„Ÿè§‰è„¸éƒ¨æ¾å¼›äº†æ€ä¹ˆåŠ	æ²»ç–—æ–¹æ¡ˆ
å°å­©çš„çœ‰æ¯›å‰ªäº†ä¼šé•¿å—ï¼Ÿ	å…¶ä»–
172çš„èº«é«˜è¿˜èƒ½é•¿é«˜å—ï¼Ÿ	å…¶ä»–
å†»ç–®ç”¨ä¸‰é‡‘å†»ç–®é…Šæœ‰æ•ˆæœä¹ˆï¼Ÿ	åŠŸæ•ˆä½œç”¨
...
```

**åˆ†ç±»æ ‡ç­¾**

label.txt(åˆ†ç±»æ ‡ç­¾æ–‡ä»¶)è®°å½•æ•°æ®é›†ä¸­æ‰€æœ‰æ ‡ç­¾é›†åˆï¼Œæ¯ä¸€è¡Œä¸ºä¸€ä¸ªæ ‡ç­¾åã€‚
- label.txt æ–‡ä»¶æ ¼å¼ï¼š
```text
<æ ‡ç­¾>
<æ ‡ç­¾>
...
```

- label.txt æ–‡ä»¶æ ·ä¾‹ï¼š
```text
ç—…æƒ…è¯Šæ–­
æ²»ç–—æ–¹æ¡ˆ
ç—…å› åˆ†æ
æŒ‡æ ‡è§£è¯»
å°±åŒ»å»ºè®®
...
```

<a name="æ¨¡å‹è®­ç»ƒ"></a>

### 2.4 æ¨¡å‹è®­ç»ƒ

æˆ‘ä»¬æ¨èä½¿ç”¨ Trainer API å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒã€‚åªéœ€è¾“å…¥æ¨¡å‹ã€æ•°æ®é›†ç­‰å°±å¯ä»¥ä½¿ç”¨ Trainer API é«˜æ•ˆå¿«é€Ÿåœ°è¿›è¡Œé¢„è®­ç»ƒã€å¾®è°ƒå’Œæ¨¡å‹å‹ç¼©ç­‰ä»»åŠ¡ï¼Œå¯ä»¥ä¸€é”®å¯åŠ¨å¤šå¡è®­ç»ƒã€æ··åˆç²¾åº¦è®­ç»ƒã€æ¢¯åº¦ç´¯ç§¯ã€æ–­ç‚¹é‡å¯ã€æ—¥å¿—æ˜¾ç¤ºç­‰åŠŸèƒ½ï¼ŒTrainer API è¿˜é’ˆå¯¹è®­ç»ƒè¿‡ç¨‹çš„é€šç”¨è®­ç»ƒé…ç½®åšäº†å°è£…ï¼Œæ¯”å¦‚ï¼šä¼˜åŒ–å™¨ã€å­¦ä¹ ç‡è°ƒåº¦ç­‰ã€‚

#### 2.4.1 é¢„è®­ç»ƒæ¨¡å‹å¾®è°ƒ


ä½¿ç”¨CPU/GPUè®­ç»ƒï¼Œé»˜è®¤ä¸ºGPUè®­ç»ƒã€‚ä½¿ç”¨CPUè®­ç»ƒåªéœ€å°†è®¾å¤‡å‚æ•°é…ç½®æ”¹ä¸º`--device cpu`ï¼Œå¯ä»¥ä½¿ç”¨`--device gpu:0`æŒ‡å®šGPUå¡å·ï¼š
```shell
python train.py \
    --do_train \
    --do_eval \
    --do_export \
    --model_name_or_path ernie-3.0-tiny-medium-v2-zh \
    --output_dir checkpoint \
    --device gpu \
    --num_train_epochs 100 \
    --early_stopping True \
    --early_stopping_patience 5 \
    --learning_rate 3e-5 \
    --max_length 128 \
    --per_device_eval_batch_size 32 \
    --per_device_train_batch_size 32 \
    --metric_for_best_model accuracy \
    --load_best_model_at_end \
    --logging_steps 5 \
    --evaluation_strategy epoch \
    --save_strategy epoch \
    --save_total_limit 1
```

å¦‚æœåœ¨GPUç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¯ä»¥æŒ‡å®š`gpus`å‚æ•°è¿›è¡Œå¤šå¡åˆ†å¸ƒå¼è®­ç»ƒã€‚ä½¿ç”¨å¤šå¡è®­ç»ƒå¯ä»¥æŒ‡å®šå¤šä¸ªGPUå¡å·ï¼Œä¾‹å¦‚ --gpus 0,1ã€‚å¦‚æœè®¾å¤‡åªæœ‰ä¸€ä¸ªGPUå¡å·é»˜è®¤ä¸º0ï¼Œå¯ä½¿ç”¨`nvidia-smi`å‘½ä»¤æŸ¥çœ‹GPUä½¿ç”¨æƒ…å†µ:

```shell
unset CUDA_VISIBLE_DEVICES
python -m paddle.distributed.launch --gpus 0,1 train.py \
    --do_train \
    --do_eval \
    --do_export \
    --model_name_or_path ernie-3.0-tiny-medium-v2-zh \
    --output_dir checkpoint \
    --device gpu \
    --num_train_epochs 100 \
    --early_stopping True \
    --early_stopping_patience 5 \
    --learning_rate 3e-5 \
    --max_length 128 \
    --per_device_eval_batch_size 32 \
    --per_device_train_batch_size 32 \
    --metric_for_best_model accuracy \
    --load_best_model_at_end \
    --logging_steps 5 \
    --evaluation_strategy epoch \
    --save_strategy epoch \
    --save_total_limit 1
```

ä¸»è¦çš„é…ç½®çš„å‚æ•°ä¸ºï¼š
- `do_train`: æ˜¯å¦è¿›è¡Œè®­ç»ƒã€‚
- `do_eval`: æ˜¯å¦è¿›è¡Œè¯„ä¼°ã€‚
- `debug`: ä¸`do_eval`é…åˆä½¿ç”¨ï¼Œæ˜¯å¦å¼€å¯debugæ¨¡å‹ï¼Œå¯¹æ¯ä¸€ä¸ªç±»åˆ«è¿›è¡Œè¯„ä¼°ã€‚
- `do_export`: è®­ç»ƒç»“æŸåæ˜¯å¦å¯¼å‡ºé™æ€å›¾ã€‚
- `do_compress`: è®­ç»ƒç»“æŸåæ˜¯å¦è¿›è¡Œæ¨¡å‹è£å‰ªã€‚
- `model_name_or_path`: å†…ç½®æ¨¡å‹åï¼Œæˆ–è€…æ¨¡å‹å‚æ•°é…ç½®ç›®å½•è·¯å¾„ã€‚é»˜è®¤ä¸º`ernie-3.0-tiny-medium-v2-zh`ã€‚
- `output_dir`: æ¨¡å‹å‚æ•°ã€è®­ç»ƒæ—¥å¿—å’Œé™æ€å›¾å¯¼å‡ºçš„ä¿å­˜ç›®å½•ã€‚
- `device`: ä½¿ç”¨çš„è®¾å¤‡ï¼Œé»˜è®¤ä¸º`gpu`ã€‚
- `num_train_epochs`: è®­ç»ƒè½®æ¬¡ï¼Œä½¿ç”¨æ—©åœæ³•æ—¶å¯ä»¥é€‰æ‹©100ã€‚
- `early_stopping`: æ˜¯å¦ä½¿ç”¨æ—©åœæ³•ï¼Œä¹Ÿå³ä¸€å®šè½®æ¬¡åè¯„ä¼°æŒ‡æ ‡ä¸å†å¢é•¿åˆ™åœæ­¢è®­ç»ƒã€‚
- `early_stopping_patience`: åœ¨è®¾å®šçš„æ—©åœè®­ç»ƒè½®æ¬¡å†…ï¼Œæ¨¡å‹åœ¨å¼€å‘é›†ä¸Šè¡¨ç°ä¸å†ä¸Šå‡ï¼Œè®­ç»ƒç»ˆæ­¢ï¼›é»˜è®¤ä¸º4ã€‚
- `learning_rate`: é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹å‚æ•°åŸºç¡€å­¦ä¹ ç‡å¤§å°ï¼Œå°†ä¸learning rate scheduleräº§ç”Ÿçš„å€¼ç›¸ä¹˜ä½œä¸ºå½“å‰å­¦ä¹ ç‡ã€‚
- `max_length`: æœ€å¤§å¥å­é•¿åº¦ï¼Œè¶…è¿‡è¯¥é•¿åº¦çš„æ–‡æœ¬å°†è¢«æˆªæ–­ï¼Œä¸è¶³çš„ä»¥Padè¡¥å…¨ã€‚æç¤ºæ–‡æœ¬ä¸ä¼šè¢«æˆªæ–­ã€‚
- `per_device_train_batch_size`: æ¯æ¬¡è®­ç»ƒæ¯å¼ å¡ä¸Šçš„æ ·æœ¬æ•°é‡ã€‚å¯æ ¹æ®å®é™…GPUæ˜¾å­˜é€‚å½“è°ƒå°/è°ƒå¤§æ­¤é…ç½®ã€‚
- `per_device_eval_batch_size`: æ¯æ¬¡è¯„ä¼°æ¯å¼ å¡ä¸Šçš„æ ·æœ¬æ•°é‡ã€‚å¯æ ¹æ®å®é™…GPUæ˜¾å­˜é€‚å½“è°ƒå°/è°ƒå¤§æ­¤é…ç½®ã€‚
- `max_length`: æœ€å¤§å¥å­é•¿åº¦ï¼Œè¶…è¿‡è¯¥é•¿åº¦çš„æ–‡æœ¬å°†è¢«æˆªæ–­ï¼Œä¸è¶³çš„ä»¥Padè¡¥å…¨ã€‚æç¤ºæ–‡æœ¬ä¸ä¼šè¢«æˆªæ–­ã€‚
- `train_path`: è®­ç»ƒé›†è·¯å¾„ï¼Œé»˜è®¤ä¸º"./data/train.txt"ã€‚
- `dev_path`: å¼€å‘é›†é›†è·¯å¾„ï¼Œé»˜è®¤ä¸º"./data/dev.txt"ã€‚
- `test_path`: æµ‹è¯•é›†è·¯å¾„ï¼Œé»˜è®¤ä¸º"./data/dev.txt"ã€‚
- `label_path`: æ ‡ç­¾è·¯å¾„ï¼Œé»˜è®¤ä¸º"./data/label.txt"ã€‚
- `bad_case_path`: é”™è¯¯æ ·æœ¬ä¿å­˜è·¯å¾„ï¼Œé»˜è®¤ä¸º"./data/bad_case.txt"ã€‚
- `width_mult_list`ï¼šè£å‰ªå®½åº¦ï¼ˆmulti headï¼‰ä¿ç•™çš„æ¯”ä¾‹åˆ—è¡¨ï¼Œè¡¨ç¤ºå¯¹self_attentionä¸­çš„ `q`ã€`k`ã€`v` ä»¥åŠ `ffn` æƒé‡å®½åº¦çš„ä¿ç•™æ¯”ä¾‹ï¼Œä¿ç•™æ¯”ä¾‹ä¹˜ä»¥å®½åº¦ï¼ˆmulti haedæ•°é‡ï¼‰åº”ä¸ºæ•´æ•°ï¼›é»˜è®¤æ˜¯Noneã€‚
è®­ç»ƒè„šæœ¬æ”¯æŒæ‰€æœ‰`TrainingArguments`çš„å‚æ•°ï¼Œæ›´å¤šå‚æ•°ä»‹ç»å¯å‚è€ƒ[TrainingArguments å‚æ•°ä»‹ç»](https://paddlenlp.readthedocs.io/zh/latest/trainer.html#trainingarguments)ã€‚

ç¨‹åºè¿è¡Œæ—¶å°†ä¼šè‡ªåŠ¨è¿›è¡Œè®­ç»ƒï¼Œè¯„ä¼°ã€‚åŒæ—¶è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ä¿å­˜å¼€å‘é›†ä¸Šæœ€ä½³æ¨¡å‹åœ¨æŒ‡å®šçš„ `output_dir` ä¸­ï¼Œä¿å­˜æ¨¡å‹æ–‡ä»¶ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

```text
checkpoint/
â”œâ”€â”€ export # é™æ€å›¾æ¨¡å‹
â”œâ”€â”€ config.json # æ¨¡å‹é…ç½®æ–‡ä»¶
â”œâ”€â”€ model_state.pdparams # æ¨¡å‹å‚æ•°æ–‡ä»¶
â”œâ”€â”€ tokenizer_config.json # åˆ†è¯å™¨é…ç½®æ–‡ä»¶
â”œâ”€â”€ vocab.txt
â””â”€â”€ special_tokens_map.json
```

**NOTE:**
* ä¸­æ–‡è®­ç»ƒä»»åŠ¡ï¼ˆæ–‡æœ¬æ”¯æŒå«éƒ¨åˆ†è‹±æ–‡ï¼‰æ¨èä½¿ç”¨"ernie-1.0-large-zh-cw"ã€"ernie-3.0-tiny-base-v2-zh"ã€"ernie-3.0-tiny-medium-v2-zh"ã€"ernie-3.0-tiny-micro-v2-zh"ã€"ernie-3.0-tiny-mini-v2-zh"ã€"ernie-3.0-tiny-nano-v2-zh"ã€"ernie-3.0-tiny-pico-v2-zh"ã€‚
* è‹±æ–‡è®­ç»ƒä»»åŠ¡æ¨èä½¿ç”¨"ernie-3.0-tiny-mini-v2-en"ã€ "ernie-2.0-base-en"ã€"ernie-2.0-large-en"ã€‚
* è‹±æ–‡å’Œä¸­æ–‡ä»¥å¤–è¯­è¨€çš„æ–‡æœ¬åˆ†ç±»ä»»åŠ¡ï¼Œæ¨èä½¿ç”¨åŸºäº96ç§è¯­è¨€ï¼ˆæ¶µç›–æ³•è¯­ã€æ—¥è¯­ã€éŸ©è¯­ã€å¾·è¯­ã€è¥¿ç­ç‰™è¯­ç­‰å‡ ä¹æ‰€æœ‰å¸¸è§è¯­è¨€ï¼‰è¿›è¡Œé¢„è®­ç»ƒçš„å¤šè¯­è¨€é¢„è®­ç»ƒæ¨¡å‹"ernie-m-base"ã€"ernie-m-large"ï¼Œè¯¦æƒ…è¯·å‚è§[ERNIE-Mè®ºæ–‡](https://arxiv.org/pdf/2012.15674.pdf)ã€‚

#### 2.4.2 è®­ç»ƒè¯„ä¼°
è®­ç»ƒåçš„æ¨¡å‹æˆ‘ä»¬å¯ä»¥å¼€å¯`debug`æ¨¡å¼ï¼Œå¯¹æ¯ä¸ªç±»åˆ«åˆ†åˆ«è¿›è¡Œè¯„ä¼°ï¼Œå¹¶æ‰“å°é”™è¯¯é¢„æµ‹æ ·æœ¬ä¿å­˜åœ¨`bad_case.txt`ã€‚é»˜è®¤åœ¨GPUç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œåœ¨CPUç¯å¢ƒä¸‹ä¿®æ”¹å‚æ•°é…ç½®ä¸º`--device "cpu"`:

```shell
python train.py \
    --do_eval \
    --debug True \
    --device gpu \
    --model_name_or_path checkpoint \
    --output_dir checkpoint \
    --per_device_eval_batch_size 32 \
    --max_length 128 \
    --test_path './data/dev.txt'
```

è¾“å‡ºæ‰“å°ç¤ºä¾‹ï¼š

```text
[2023-02-14 12:35:03,470] [    INFO] - -----Evaluate model-------
[2023-02-14 12:35:03,471] [    INFO] - Dev dataset size: 1955
[2023-02-14 12:35:03,471] [    INFO] - Accuracy in dev dataset: 81.74%
[2023-02-14 12:35:03,471] [    INFO] - Macro average | precision: 77.39 | recall: 79.89 | F1 score 78.32
[2023-02-14 12:35:03,471] [    INFO] - Class name: ç—…æƒ…è¯Šæ–­
[2023-02-14 12:35:03,471] [    INFO] - Evaluation examples in dev dataset: 288(14.7%) | precision: 85.22 | recall: 86.11 | F1 score 85.66
[2023-02-14 12:35:03,471] [    INFO] - ----------------------------
[2023-02-14 12:35:03,471] [    INFO] - Class name: æ²»ç–—æ–¹æ¡ˆ
[2023-02-14 12:35:03,471] [    INFO] - Evaluation examples in dev dataset: 676(34.6%) | precision: 91.72 | recall: 90.09 | F1 score 90.90
...
```

æ–‡æœ¬åˆ†ç±»é¢„æµ‹è¿‡ç¨‹ä¸­å¸¸ä¼šé‡åˆ°è¯¸å¦‚"æ¨¡å‹ä¸ºä»€ä¹ˆä¼šé¢„æµ‹å‡ºé”™è¯¯çš„ç»“æœ"ï¼Œ"å¦‚ä½•æå‡æ¨¡å‹çš„è¡¨ç°"ç­‰é—®é¢˜ã€‚[Analysisæ¨¡å—](./analysis) æä¾›äº†**å¯è§£é‡Šæ€§åˆ†æã€æ•°æ®ä¼˜åŒ–**ç­‰åŠŸèƒ½ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°åˆ†ææ–‡æœ¬åˆ†ç±»æ¨¡å‹é¢„æµ‹ç»“æœå’Œå¯¹æ¨¡å‹æ•ˆæœè¿›è¡Œä¼˜åŒ–ã€‚

#### 2.4.3 æ¨¡å‹è£å‰ª(å¯é€‰)

å¦‚æœæœ‰æ¨¡å‹éƒ¨ç½²ä¸Šçº¿çš„éœ€æ±‚ï¼Œéœ€è¦è¿›ä¸€æ­¥å‹ç¼©æ¨¡å‹ä½“ç§¯ï¼Œå¯ä»¥ä½¿ç”¨ PaddleNLP çš„ [å‹ç¼©API](https://github.com/PaddlePaddle/PaddleNLP/blob/develop/docs/compression.md), ä¸€è¡Œå‘½ä»¤å³å¯å¯åŠ¨æ¨¡å‹è£å‰ªã€‚

ä½¿ç”¨è£å‰ªåŠŸèƒ½éœ€è¦å®‰è£… paddleslimï¼š

```shell
pip install paddleslim == 2.4.1
```

å¼€å§‹æ¨¡å‹è£å‰ªè®­ç»ƒï¼Œé»˜è®¤ä¸ºGPUè®­ç»ƒï¼Œä½¿ç”¨CPUè®­ç»ƒåªéœ€å°†è®¾å¤‡å‚æ•°é…ç½®æ”¹ä¸º`--device "cpu"`ï¼š
```shell
python train.py \
    --do_compress \
    --device gpu \
    --data_dir data \
    --model_name_or_path checkpoint \
    --output_dir checkpoint/prune \
    --learning_rate 3e-5 \
    --per_device_train_batch_size 32 \
    --per_device_eval_batch_size 32 \
    --num_train_epochs 1 \
    --max_length 128 \
    --logging_steps 5 \
    --save_steps 100 \
    --width_mult_list '3/4' '2/3' '1/2'
```
ä¿å­˜æ¨¡å‹æ–‡ä»¶ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

```text
checkpoint/prune/
â”œâ”€â”€ width_mult_0.75
â”‚Â Â  â”œâ”€â”€ pruned_model.pdiparams
â”‚Â Â  â”œâ”€â”€ pruned_model.pdiparams.info
â”‚Â Â  â”œâ”€â”€ pruned_model.pdmodel
â”‚Â Â  â”œâ”€â”€ model_state.pdparams
â”‚Â Â  â””â”€â”€ config.json
â””â”€â”€ ...
```
**NOTE:**

1. ç›®å‰æ”¯æŒçš„è£å‰ªç­–ç•¥éœ€è¦è®­ç»ƒï¼Œè®­ç»ƒæ—¶é—´è§†ä¸‹æ¸¸ä»»åŠ¡æ•°æ®é‡è€Œå®šï¼Œä¸”å’Œå¾®è°ƒçš„è®­ç»ƒæ—¶é—´æ˜¯ä¸€ä¸ªé‡çº§ã€‚ è£å‰ªç±»ä¼¼è’¸é¦è¿‡ç¨‹ï¼Œæ–¹ä¾¿èµ·è§ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¾®è°ƒæ—¶çš„è¶…å‚ã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡ç²¾åº¦ï¼Œå¯ä»¥å¯¹ `per_device_train_batch_size`ã€`learning_rate`ã€`max_length` ç­‰è¶…å‚è¿›è¡Œç½‘æ ¼æœç´¢ï¼ˆgrid searchï¼‰ã€‚

2. æ¨¡å‹è£å‰ªä¸»è¦ç”¨äºæ¨ç†éƒ¨ç½²ï¼Œå› æ­¤è£å‰ªåçš„æ¨¡å‹éƒ½æ˜¯é™æ€å›¾æ¨¡å‹ï¼Œåªå¯ç”¨äºæ¨ç†éƒ¨ç½²ã€‚

3. ERNIE Baseã€Mediumã€Miniã€Microã€Nanoçš„æ¨¡å‹å®½åº¦ï¼ˆmulti headæ•°é‡ï¼‰ä¸º12ï¼ŒERNIE Xbaseã€Large æ¨¡å‹å®½åº¦ï¼ˆmulti headæ•°é‡ï¼‰ä¸º16ï¼Œä¿ç•™æ¯”ä¾‹`width_mult`ä¹˜ä»¥å®½åº¦ï¼ˆmulti haedæ•°é‡ï¼‰åº”ä¸ºæ•´æ•°ã€‚

<a name="æ¨¡å‹é¢„æµ‹"></a>

### 2.5 æ¨¡å‹é¢„æµ‹
æˆ‘ä»¬æ¨èä½¿ç”¨taskflowè¿›è¡Œæ¨¡å‹é¢„æµ‹ï¼Œè¯·ä¿è¯paddlenlpç‰ˆæœ¬å¤§äº2.5.1ã€‚
```
from paddlenlp import Taskflow

# æ¨¡å‹é¢„æµ‹
cls = Taskflow("text_classification", task_path='checkpoint/export', is_static_model=True)
cls(["é»‘è‹¦èèŒ¶çš„åŠŸæ•ˆä¸ä½œç”¨åŠé£Ÿç”¨æ–¹æ³•","å¹¼å„¿æŒ‘é£Ÿçš„ç”Ÿç†åŸå› æ˜¯"])
# [{'predictions': [{'label': 'åŠŸæ•ˆä½œç”¨', 'score': 0.9683999621710758}], 'text': 'é»‘è‹¦èèŒ¶çš„åŠŸæ•ˆä¸ä½œç”¨åŠé£Ÿç”¨æ–¹æ³•'}, {'predictions': [{'label': 'ç—…å› åˆ†æ', 'score': 0.5204789523701855}], 'text': 'å¹¼å„¿æŒ‘é£Ÿçš„ç”Ÿç†åŸå› æ˜¯'}]

# è£å‰ªæ¨¡å‹é¢„æµ‹
cls = Taskflow("text_classification", task_path='checkpoint/prune/width_mult_0.67', is_static_model=True)
cls(["é»‘è‹¦èèŒ¶çš„åŠŸæ•ˆä¸ä½œç”¨åŠé£Ÿç”¨æ–¹æ³•","å¹¼å„¿æŒ‘é£Ÿçš„ç”Ÿç†åŸå› æ˜¯"])
# [{'predictions': [{'label': 'åŠŸæ•ˆä½œç”¨', 'score': 0.964693000149321}], 'text': 'é»‘è‹¦èèŒ¶çš„åŠŸæ•ˆä¸ä½œç”¨åŠé£Ÿç”¨æ–¹æ³•'}, {'predictions': [{'label': 'ç—…å› åˆ†æ', 'score': 0.4915921440237312}], 'text': 'å¹¼å„¿æŒ‘é£Ÿçš„ç”Ÿç†åŸå› æ˜¯'}]
```

#### å¯é…ç½®å‚æ•°è¯´æ˜
* `task_path`ï¼šè‡ªå®šä¹‰ä»»åŠ¡è·¯å¾„ï¼Œé»˜è®¤ä¸ºNoneã€‚
* `is_static_model`ï¼štask_pathä¸­æ˜¯å¦ä¸ºé™æ€å›¾æ¨¡å‹å‚æ•°ï¼Œé»˜è®¤ä¸ºFalseã€‚
* `max_length`ï¼šæœ€é•¿è¾“å…¥é•¿åº¦ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ‡ç­¾çš„é•¿åº¦ï¼Œé»˜è®¤ä¸º512ã€‚
* `batch_size`ï¼šæ‰¹å¤„ç†å¤§å°ï¼Œè¯·ç»“åˆæœºå™¨æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼Œé»˜è®¤ä¸º1ã€‚
* `id2label`ï¼šæ ‡ç­¾æ˜ å°„å­—å…¸ï¼Œå¦‚æœ`task_path`ä¸­åŒ…å«id2label.jsonæˆ–åŠ è½½åŠ¨æ€å›¾å‚æ•°æ— éœ€å®šä¹‰ã€‚
* `precision`ï¼šé€‰æ‹©æ¨¡å‹ç²¾åº¦ï¼Œé»˜è®¤ä¸º`fp32`ï¼Œå¯é€‰æœ‰`fp16`å’Œ`fp32`ã€‚`fp16`æ¨ç†é€Ÿåº¦æ›´å¿«ã€‚å¦‚æœé€‰æ‹©`fp16`ï¼Œè¯·å…ˆç¡®ä¿æœºå™¨æ­£ç¡®å®‰è£…NVIDIAç›¸å…³é©±åŠ¨å’ŒåŸºç¡€è½¯ä»¶ï¼Œ**ç¡®ä¿CUDA>=11.2ï¼ŒcuDNN>=8.1.1**ï¼Œåˆæ¬¡ä½¿ç”¨éœ€æŒ‰ç…§æç¤ºå®‰è£…ç›¸å…³ä¾èµ–ã€‚å…¶æ¬¡ï¼Œéœ€è¦ç¡®ä¿GPUè®¾å¤‡çš„CUDAè®¡ç®—èƒ½åŠ›ï¼ˆCUDA Compute Capabilityï¼‰å¤§äº7.0ï¼Œå…¸å‹çš„è®¾å¤‡åŒ…æ‹¬V100ã€T4ã€A10ã€A100ã€GTX 20ç³»åˆ—å’Œ30ç³»åˆ—æ˜¾å¡ç­‰ã€‚æ›´å¤šå…³äºCUDA Compute Capabilityå’Œç²¾åº¦æ”¯æŒæƒ…å†µè¯·å‚è€ƒNVIDIAæ–‡æ¡£ï¼š[GPUç¡¬ä»¶ä¸æ”¯æŒç²¾åº¦å¯¹ç…§è¡¨](https://docs.nvidia.com/deeplearning/tensorrt/archives/tensorrt-840-ea/support-matrix/index.html#hardware-precision-matrix)ã€‚

åœ¨çº¿æœåŠ¡åŒ–éƒ¨ç½²æ­å»ºè¯·å‚è€ƒï¼š
- ã€ç®€å•æ˜“ç”¨ã€‘ ğŸ‘‰ [Simple Servingéƒ¨ç½²æŒ‡å—](deploy/simple_serving)
- ã€ä½æ—¶å»¶ã€‘ ğŸ‘‰ [Tritonéƒ¨ç½²æŒ‡å—](deploy/triton_serving)ã€‚


<a name="æ¨¡å‹æ•ˆæœ"></a>

### 2.6 æ¨¡å‹æ•ˆæœ

PaddleNLPæä¾›ERNIE 3.0 å…¨ç³»åˆ—è½»é‡åŒ–æ¨¡å‹ï¼Œå¯¹äºä¸­æ–‡è®­ç»ƒä»»åŠ¡å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©ä¸åŒçš„é¢„è®­ç»ƒæ¨¡å‹å‚æ•°è¿›è¡Œè®­ç»ƒï¼Œæˆ‘ä»¬è¯„æµ‹äº†ä¸åŒé¢„è®­ç»ƒæ¨¡å‹åœ¨KUAKE-QICä»»åŠ¡çš„è¡¨ç°ï¼Œæµ‹è¯•é…ç½®å¦‚ä¸‹ï¼š

1. æ•°æ®é›†ï¼šCBLUEæ•°æ®é›†ä¸­åŒ»ç–—æœç´¢æ£€ç´¢è¯æ„å›¾åˆ†ç±»(KUAKE-QIC)ä»»åŠ¡å¼€å‘é›†

2. ç‰©ç†æœºç¯å¢ƒ

    ç³»ç»Ÿ: CentOS Linux release 7.7.1908 (Core)

    GPU: Tesla V100-SXM2-32GB

    CPU: Intel(R) Xeon(R) Gold 6271C CPU @ 2.60GHz

    CUDA: 11.2

    cuDNN: 8.1.0

    Driver Version: 460.27.04

    å†…å­˜: 630 GB

3. PaddlePaddle ç‰ˆæœ¬ï¼š2.3.0

4. PaddleNLP ç‰ˆæœ¬ï¼š2.3.1

5. æ€§èƒ½æ•°æ®æŒ‡æ ‡ï¼šlatencyã€‚latency æµ‹è¯•æ–¹æ³•ï¼šå›ºå®š batch size ä¸º 32ï¼ŒGPUéƒ¨ç½²è¿è¡Œæ—¶é—´ total_timeï¼Œè®¡ç®— latency = total_time / total_samples

6. ç²¾åº¦è¯„ä»·æŒ‡æ ‡ï¼šAccuracy

|  model_name  | æ¨¡å‹ç»“æ„  |Accuracy(%)   | latency(ms) |
| -------------------------- | ------------ | ------------ | ------------ |
|ERNIE 1.0 Large Cw |24-layer, 1024-hidden, 20-heads|82.30| 5.62 |
|ERNIE 3.0 Base  |12-layer, 768-hidden, 12-heads|82.25| 2.07 |
|ERNIE 3.0 Medium| 6-layer, 768-hidden, 12-heads|81.79| 1.07|
|ERNIE 3.0 Mini |6-layer, 384-hidden, 12-heads|79.80| 0.38|
|ERNIE 3.0 Micro | 4-layer, 384-hidden, 12-heads|79.80| 0.26|
|ERNIE 3.0 Nano |4-layer, 312-hidden, 12-heads|78.57|0.22|
| ERNIE 3.0 Medium + è£å‰ª(ä¿ç•™æ¯”ä¾‹3/4)|6-layer, 768-hidden, 9-heads| 81.79| 0.83   |
| ERNIE 3.0 Medium + è£å‰ª(ä¿ç•™æ¯”ä¾‹2/3)|6-layer, 768-hidden, 8-heads| 81.07  | 0.79  |
| ERNIE 3.0 Medium + è£å‰ª(ä¿ç•™æ¯”ä¾‹1/2)|6-layer, 768-hidden, 6-heads| 81.07 | 0.64  |
